<div class="add-booking-form">
  <header>
    <h1>Créer une réservation</h1>
  </header>
  <form [formGroup]="bookingForm" (ngSubmit)="onSubmit()" autocomplete="off">
    <!-- Movie select -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Film</mat-label>
      <mat-select formControlName="movieId" required>
        <mat-option value="">Choisir un film</mat-option>
        <mat-option *ngFor="let movie of movies()" [value]="movie.movieId">
          {{ movie.title }}
        </mat-option>
      </mat-select>
      <mat-error *ngIf="hasFieldError('movieId')"
        >{{ getFieldError('movieId') }}</mat-error
      >
    </mat-form-field>

    <!-- Theater select -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Cinéma</mat-label>
      <mat-select formControlName="theaterId" required>
        <mat-option value="">Choisir un cinéma</mat-option>
        <mat-option
          *ngFor="let theater of theaters()"
          [value]="theater.theaterId"
        >
          {{ theater.theaterId }} - {{ theater.city }}
        </mat-option>
      </mat-select>
      <mat-error *ngIf="hasFieldError('theaterId')"
        >{{ getFieldError('theaterId') }}</mat-error
      >
    </mat-form-field>

    <!-- Date picker -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Date</mat-label>
      <input
        matInput
        [matDatepicker]="picker"
        formControlName="date"
        required
        autocomplete="off"
      />
      <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
      <mat-datepicker #picker></mat-datepicker>
      <mat-error *ngIf="hasFieldError('date')"
        >{{ getFieldError('date') }}</mat-error
      >
    </mat-form-field>

    <!-- Screenings select -->
    <ng-container *ngIf="screenings().length > 0; else noScreenings">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Séance</mat-label>
        <mat-select formControlName="screeningId" required>
          <mat-option value="">Choisir une séance</mat-option>
          <mat-option
            *ngFor="let screening of screenings()"
            [value]="screening.screeningId"
          >
            {{ screening.startTime | date:'shortTime' }} - Salle {{
            screening.hallId }} - {{screening.hall?.quality}}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="hasFieldError('screeningId')">
          {{ getFieldError('screeningId') }}
        </mat-error>
      </mat-form-field>
    </ng-container>
    <ng-template #noScreenings>
      <div
        *ngIf="bookingForm.get('movieId')?.value && bookingForm.get('theaterId')?.value && bookingForm.get('date')?.value"
        class="no-screenings-msg"
      >
        Aucune séance disponible pour cette date.
      </div>
    </ng-template>

    <!-- Seat selection table -->
    <div *ngIf="seatsLayout().length > 0" class="seats-container">
      <table>
        <tbody>
          <tr *ngFor="let row of seatsLayout(); let i = index">
            <td
              *ngFor="let seat of row; let j = index"
              class="seat"
              [class.empty]="seat === 'x'"
              [class.selected]="isSeatSelected(seat)"
              [class.disabled]="seat === 'x' || isSeatBooked(seat)"
              (click)="seat !== 'x' && !isSeatBooked(seat) && toggleSeat(seat)"
              [attr.aria-disabled]="isSeatBooked(seat) ? 'true' : null"
              [attr.tabindex]="seat !== 'x' && !isSeatBooked(seat) ? 0 : null"
            >
              <div class="seat-backrest"></div>
              <div class="seat-bottom">{{ seat !== 'x' ? seat : '' }}</div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Auto-calculated fields -->
    <div class="auto-fields-container">
      <div class="auto-field">
        <label for="selectedSeatsCount">Nombre de places sélectionnée</label>
        <input
          id="selectedSeatsCount"
          type="text"
          class="auto-calculated-field"
          [value]="selectedSeats().length"
          placeholder="Nombre de places sélectionnée"
          disabled
        />
      </div>

      <div class="auto-field">
        <label for="selectedSeatsIds">IDs des sièges sélectionnés</label>
        <input
          id="selectedSeatsIds"
          type="text"
          class="auto-calculated-field"
          [value]="selectedSeats().join(', ')"
          placeholder="IDs des sièges sélectionnés"
          disabled
        />
      </div>
    </div>

    <!-- Total price -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Prix total (€)</mat-label>
      <input
        matInput
        formControlName="totalPrice"
        type="number"
        min="0"
        step="0.01"
        readonly
      />
      <mat-error *ngIf="hasFieldError('totalPrice')"
        >{{ getFieldError('totalPrice') }}</mat-error
      >
    </mat-form-field>

    <!-- Submit button -->
    <div class="form-actions">
      <button
        mat-raised-button
        color="primary"
        class="full-width"
        type="submit"
        [disabled]="bookingForm.invalid || isLoading()"
      >
        <ng-container *ngIf="isLoading(); else notLoading">
          <mat-icon>hourglass_empty</mat-icon> Réservation en cours...
        </ng-container>
        <ng-template #notLoading>
          <mat-icon>check</mat-icon> Réserver
        </ng-template>
      </button>
    </div>

    <!-- Success & Error messages -->
    <div *ngIf="successMessage()" class="success-message">
      <mat-icon>check_circle</mat-icon> {{ successMessage() }}
    </div>
    <div *ngIf="apiError()" class="api-error-message">
      <mat-icon>error</mat-icon> {{ apiError() }}
    </div>
  </form>
</div>
